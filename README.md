# Excel差分ハイライトツール

Excelファイルの新旧バージョンを比較し、変更された文字のみをハイライトするツールです。

## 機能

- ✅ 新旧2つのフォルダを指定して、ディレクトリ配下の全Excelファイルを一括処理
- ✅ 差分がある文字のみをハイライト（セル全体ではなく文字単位）
- ✅ **差分サマリーシート自動作成**（変更箇所一覧を最初のシートに表示）
- ✅ **HTMLレポート自動生成**（処理結果を視覚的に確認できる統計レポート）
- ✅ **6色のハイライト色を選択可能**（青・緑・オレンジ・紫・ピンク・赤）
- ✅ **比較モード選択**（表示値のみ / 数式も含む）
- ✅ ファイル名の自動マッチング（バージョン番号の違いを自動判別）
- ✅ 「v2.09 のコピー」などの特殊なファイル名にも対応
- ✅ マッチングしないファイルも警告表示
- ✅ フォントサイズ、フォント名、下線などのフォーマットを維持
- ✅ パス入力時のダブルクォーテーションを自動除去
- ✅ 大量セル処理時の進捗表示（10%刻み）

## セットアップ

- ExcelDiffHighlighter.exeの初回起動時、Windowsセキュリティの警告が出る可能性あるので「右クリック」→「管理者として実行」で起動できます。
- 前提として比較する設計書の最新バージョンと旧バージョンを事前にローカルにダウンロードしてください。
- 旧バージョンは対象のファイルを右クリックし「バージョン履歴」を選択してダウンロードする。
　番号が「1.0」の2025/8～2025/9当たりの詳細設計後の設計書が対象。

実行すると以下の情報を入力するよう求められます：

1. **ハイライト色の選択**
   - 1: 青 (Blue)
   - 2: 緑 (Green)
   - 3: オレンジ (Orange)
   - 4: 紫 (Purple)
   - 5: ピンク (Pink)
   - 6: 赤 (Red)
   - デフォルト: 青

2. **比較モードの選択**
   - 1: 表示値のみ比較（数式は計算結果で比較）
   - 2: 数式を比較（数式がある場合は数式文字列を比較）
   - デフォルト: 表示値のみ

3. **旧バージョンのフォルダパス**
   - 例: `C:\Users\Desktop\old_versions`
   - ダブルクォーテーション付きでも可

4. **新バージョンのフォルダパス**
   - 例: `C:\Users\Desktop\new_versions`

5. **出力先フォルダパス**
   - 例: `C:\Users\Desktop\output`
   - 空欄の場合は新バージョンと同じフォルダに出力

### 実行例

```
============================================================
Excel差分ハイライトツール
============================================================

旧バージョンと新バージョンがそれぞれ別のフォルダにあり、
同じファイル名（ベース名）のペアをすべて自動処理します。

差分をハイライトする色を選択してください:
1. 青 (Blue)
2. 緑 (Green)
3. オレンジ (Orange)
4. 紫 (Purple)
5. ピンク (Pink)
6. 赤 (Red)

選択 (1-6, デフォルト: 1): 1
選択された色: 青

差分比較のモードを選択してください:
1. 表示値のみ比較（数式は比較しない）
2. 数式を比較（数式がある場合は数式を比較）

選択 (1-2, デフォルト: 1): 1
選択されたモード: 表示値

旧バージョンのフォルダを指定してください
旧バージョンのフォルダパス: C:\work\old_versions

新バージョンのフォルダを指定してください
新バージョンのフォルダパス: C:\work\new_versions

出力先フォルダを指定してください
出力先フォルダパス（空欄で新バージョンと同じ）: C:\work\output

8 個のファイルペアが見つかりました:
1. V5_帳票スケッチ_帳票部品No.105_転出名簿2
   旧: V5_帳票スケッチ_帳票部品No.105_転出名簿2_v2.05.xlsx
   新: V5_帳票スケッチ_帳票部品No.105_転出名簿2_v2.09.xlsx
...

⚠ 旧フォルダにのみ存在するファイル（新バージョンなし）:
  - 削除予定ファイル_v1.00.xlsx

処理を開始しますか？ (y/n): y
```

## 処理の流れ

1. 旧バージョンと新バージョンの各フォルダ内の.xlsxファイルを検索
2. ファイル名のベース部分（バージョン番号を除く）でマッチング
3. マッチングしたファイルペアを一覧表示
4. マッチングしないファイルがあれば警告表示
5. 確認後、すべてのファイルペアを順次処理
6. 各セルを比較し、差分がある文字のみを指定色でハイライト
   - 表示値モード：数式セルは計算結果で比較
   - 数式モード：数式セルは数式文字列で比較
7. **差分サマリーシートを最初のシートとして自動作成**（変更箇所の一覧）
8. 「_差分ハイライト」を付けたファイル名で出力先に保存

## ファイル名のマッチングルール

以下のようなファイル名に対応しています：

- `ファイル名_v2.06.xlsx` と `ファイル名_v2.09.xlsx` → マッチング
- `ファイル名_v2.06 のコピー.xlsx` と `ファイル名_v2.09.xlsx` → マッチング
- `ファイル名_v1.00 (1).xlsx` と `ファイル名_v1.05.xlsx` → マッチング

**ルール**: バージョン番号（v + 数字.数字）以降の文字列を除いた部分が同じ場合にマッチングされます。

## 出力

- **出力ファイル名**: `元のファイル名_差分ハイライト.xlsx`
- **差分サマリーシート**: 最初のシートに変更箇所の一覧が自動作成されます
  - No.（通し番号）
  - シート名（変更があったシート）
  - セル（セル番地：A1, B2など）
  - 旧値（変更前の値、100文字まで）
  - 新値（変更後の値、100文字まで）
- **ハイライト色**: 選択した色（青・緑・オレンジ・紫・ピンク・赤）で差分を表示
- **ハイライト範囲**: 差分がある文字のみ（セル全体ではなく文字単位）
- **フォーマット維持**: フォントサイズ、フォント名、下線などは元のまま保持
- **HTMLレポート**: `diff_report.html`が自動生成され、処理結果の統計情報を確認できます

## HTMLレポート機能

処理完了後、出力フォルダに`diff_report.html`が自動生成されます。ブラウザで開くことで、以下の情報を視覚的に確認できます。

### レポートの主な機能

1. **処理統計情報**
   - 処理日時
   - 処理成功/失敗件数
   - 総差分数
   - ハイライト色
   - 比較モード

2. **グラフによる可視化**
   - **ファイル別差分数グラフ**: 各ファイルの差分件数を棒グラフで表示
   - **シート別差分数グラフ**: シート毎の差分件数を棒グラフで表示

3. **ファイル詳細情報**
   - ファイル名とステータス（成功/失敗）
   - 差分件数バッジ（総数、追加、削除、変更）
     - [25件] [3追加] [5削除] [17変更]
   - シート別の差分一覧（セル位置、旧値、新値、変更種別）
   - エラーが発生した場合の詳細情報（エラーメッセージとスタックトレース）

4. **ソート機能**
   - ファイル名（昇順/降順）
   - 差分件数（昇順/降順）
   - 元の順序
   - ドロップダウンから選択するだけで並び替え可能

5. **検索・フィルター機能**
   - ファイル名で検索（リアルタイムフィルタリング）
   - ステータスでフィルター（全て/成功/失敗）

6. **ダークモード対応**
   - 右上のトグルスイッチでライト/ダークモード切り替え
   - 設定はブラウザに保存され、次回開いた時も維持されます

7. **差分の種類**
   - **追加（緑）**: 新バージョンで追加された内容
   - **削除（赤）**: 旧バージョンから削除された内容
   - **変更（青）**: 旧バージョンから変更された内容

### HTMLレポートの使い方

1. 処理完了後、出力フォルダの`diff_report.html`をダブルクリック
2. ブラウザが起動し、レポートが表示されます
3. 各ファイル名をクリックすると詳細が展開されます
4. ソート機能で見たい順序に並び替え
5. 検索ボックスで特定のファイルを素早く検索
6. グラフで差分の多いファイルを視覚的に把握

### 注意事項

- HTMLレポートはオフラインで動作します（インターネット接続不要、CDN使用）
- グラフはChart.jsを使用しています
- ブラウザのJavaScriptが有効である必要があります

## 比較モードについて

### 表示値のみ比較（モード1、デフォルト）
- 数式セルは計算結果（表示値）で比較します
- 例：`=SUM(A1:A10)`の結果が「100」の場合、「100」として比較
- 数式が同じでも計算結果が異なれば差分として検出されます
- **推奨**：通常はこちらのモードを使用

### 数式を比較（モード2）
- 数式セルは数式文字列そのもので比較します
- 例：`=SUM(A1:A10)` vs `=SUM(A1:A11)` → 異なる数式として検出
- 計算結果が同じでも数式が異なれば差分として検出されます
- **用途**：数式の変更を追跡したい場合に使用

## 注意事項

- 元のファイルは変更されません（新しいファイルが作成されます）
- 拡張子は.xlsxのみ対応（.xlsは非対応）
- 一時ファイル（~$で始まるファイル）は自動的にスキップされます
- Excelファイルが他のプログラムで開かれている場合はエラーになります

## トラブルシューティング

### EXEファイルが起動しない場合
- **Windowsセキュリティの警告**: 初回起動時に警告が表示される場合があります
  - 解決方法：ファイルを右クリック → 「管理者として実行」を選択
  - または：ファイルを右クリック → プロパティ → 「ブロックの解除」にチェック → OK
- **ウイルス対策ソフトのブロック**: 一部のウイルス対策ソフトが実行をブロックする場合があります
  - 解決方法：ウイルス対策ソフトの設定で例外として許可

### ファイルが見つからない場合
- ディレクトリパスが正しいか確認してください
- パスにダブルクォーテーションが含まれていても自動的に除去されます
- 拡張子が.xlsxであることを確認（.xlsは非対応）
- フォルダパスをコピー＆ペーストで入力する際は、余計な空白が入らないよう注意

### マッチングしないファイルがある場合
- ファイル名のベース部分（バージョン番号を除く）が一致しているか確認
- バージョン番号が「v2.06」のような形式（v + 数字.数字）であることを確認
- 処理完了時に「新フォルダにのみ存在」「旧フォルダにのみ存在」として一覧表示されます

### エラーが発生する場合
- **ファイルアクセスエラー**: Excelファイルが他のプログラムで開かれていないか確認
- **メモリ不足**: 非常に大きなExcelファイルを処理する場合、メモリ不足になる可能性があります
  - 解決方法：一度に処理するファイル数を減らす、他のアプリケーションを閉じる
- **書き込み権限エラー**: 出力先フォルダに書き込み権限があるか確認
- エラーメッセージを確認し、該当ファイルを個別にチェックしてください
- 問題が解決しない場合は、エラーメッセージの内容をメモしてサポートに連絡

### 差分サマリーシートが表示されない場合
- 差分が1件も検出されなかった場合、サマリーシートは作成されません
- 両方のファイルが完全に同一の場合、ハイライトもサマリーシートも作成されません
- この場合でもHTMLレポートには「差分0件」として記録されます

### HTMLレポートが表示されない場合
- `diff_report.html`が出力フォルダに生成されているか確認してください
- ブラウザでJavaScriptが有効になっているか確認してください
- ブラウザのコンソールにエラーが表示されている場合は、ブラウザを最新版に更新してください

### 処理が途中で止まる場合
- プログラムは「Enterキーを押して終了...」と表示されるまで実行中です
- 大量のファイルを処理する場合は時間がかかります（進捗表示を確認）
- Ctrl+Cで処理を中断できます

## 処理結果の例

```
============================================================
処理完了
============================================================
成功: 8 ファイル
失敗: 0 ファイル
出力先: C:\work\output
HTMLレポート: C:\work\output\diff_report.html

旧フォルダにのみ存在（1 ファイル）:
  - 削除予定ファイル_v1.00.xlsx

新フォルダにのみ存在（2 ファイル）:
  - 新規ファイル_v1.00.xlsx
  - テストファイル.xlsx
```

成功したファイルは出力先フォルダに保存されます。マッチングしなかったファイルがある場合は、処理完了時に一覧が表示されます。失敗したファイルがある場合は、エラーメッセージを確認してください。HTMLレポートをブラウザで開くと、処理結果の詳細を視覚的に確認できます。
